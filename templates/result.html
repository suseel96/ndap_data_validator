{% extends "base.html" %}

{% block content %}
  <h4 class="mb-3">Step 4: Upload to AWS S3 {% if file_name %}<span class="text-muted">— {{ file_name }} ({{ record_count }} records)</span>{% endif %}</h4>
  {% if success %}
    <div class="alert alert-success">Uploaded successfully to <code>{{ s3_uri }}</code></div>
    {% if airflow_triggered %}
      <div class="alert alert-info">
        Airflow DAG <strong>{{ airflow_dag_id }}</strong> triggered.
        {% if airflow_dag_run_id %}Run ID: <code>{{ airflow_dag_run_id }}</code>.{% endif %}
        {% if airflow_run_url %}
          <a class="btn btn-sm btn-outline-primary ms-2" href="{{ airflow_run_url }}" target="_blank" rel="noreferrer">Open in Airflow</a>
        {% endif %}
      </div>
      {% if airflow_dag_run_id %}
        <div class="card mt-3" id="airflow-status-card" data-dag-id="{{ airflow_dag_id }}" data-run-id="{{ airflow_dag_run_id }}" data-token="{{ token }}">
          <div class="card-header">Airflow Run Status</div>
          <div class="card-body">
            <div id="airflow-status-message" data-role="message" class="mb-2 text-muted">Checking Airflow run status…</div>
            <div class="mb-2"><strong>Source Code:</strong> <span data-role="source-code">N/A</span></div>
            <div id="airflow-status-error" data-role="tasks-error" class="text-warning small mb-2" style="display:none;"></div>
            <div id="airflow-status-tasks" data-role="tasks" class="small"></div>
          </div>
        </div>
      {% endif %}
    {% elif airflow_error %}
      <div class="alert alert-warning">
        Airflow trigger failed: {{ airflow_error }}.
      </div>
    {% endif %}
    <a href="/?reset=1" class="btn btn-outline-primary mt-3" data-role="start-over">Start over</a>
  {% else %}
    <div class="alert alert-danger">Upload failed: {{ error }}</div>
    {% if trace %}<pre class="small">{{ trace }}</pre>{% endif %}
    <a href="/" class="btn btn-outline-secondary">Go back</a>
  {% endif %}
{% if airflow_triggered and airflow_dag_run_id and airflow_dag_id %}
  <script>
    (function () {
      const card = document.getElementById('airflow-status-card');
      if (!card) {
        return;
      }
      const dagId = card.getAttribute('data-dag-id');
      const runId = card.getAttribute('data-run-id');
      const tokenValue = card.getAttribute('data-token') || '';
      const messageEl = card.querySelector('[data-role="message"]');
      const tasksEl = card.querySelector('[data-role="tasks"]');
      const errorEl = card.querySelector('[data-role="tasks-error"]');
      const sourceEl = card.querySelector('[data-role="source-code"]');
      const startBtn = document.querySelector('[data-role="start-over"]');
      const disableStart = () => {
        if (!startBtn) return;
        startBtn.classList.add('disabled', 'pe-none', 'opacity-50');
        startBtn.setAttribute('aria-disabled', 'true');
      };
      const enableStart = () => {
        if (!startBtn) return;
        startBtn.classList.remove('disabled', 'pe-none', 'opacity-50');
        startBtn.removeAttribute('aria-disabled');
      };
      const capitalizeWords = (value) => String(value || '').replace(/\b\w/g, (ch) => ch.toUpperCase());
      if (startBtn) {
        disableStart();
      }
      const normalizeLog = (value) => {
        let text = String(value || '');
        text = text.replace(/\r\n/g, '\n');
        text = text.replace(/\\r\\n/g, '\n');
        text = text.replace(/\\n/g, '\n');
        text = text.replace(/\\t/g, '\t');
        return text;
      };
      const escapeHtml = (value) => String(value || '').replace(/[&<>"']/g, (ch) => {
        const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' };
        return map[ch] || ch;
      });
      let polling = true;

      async function pollStatus() {
        if (!polling) {
          return;
        }
        try {
          const params = new URLSearchParams({ dag_id: dagId, dag_run_id: runId });
          if (tokenValue) {
            params.append('token', tokenValue);
          }
          const resp = await fetch(`/airflow/run-status?${params.toString()}`);
          if (!resp.ok) {
            messageEl.textContent = `Unable to fetch Airflow status (HTTP ${resp.status}).`;
            if (sourceEl) {
              sourceEl.textContent = 'N/A';
            }
            polling = false;
            enableStart();
            return;
          }
          const data = await resp.json();
          messageEl.textContent = data.state ? '' : 'State is not available yet.';

          if (data.tasks_error) {
            errorEl.style.display = '';
            errorEl.textContent = `Task details unavailable: ${data.tasks_error}`;
            if (sourceEl) {
              sourceEl.textContent = 'N/A';
            }
          } else {
            errorEl.style.display = 'none';
            errorEl.textContent = '';
          }
          if (sourceEl) {
            const codeValue = (data.source_code || '').toString().trim();
            sourceEl.textContent = codeValue ? codeValue : 'N/A';
          }

          if (Array.isArray(data.tasks) && data.tasks.length) {
            tasksEl.innerHTML = data.tasks.map((task) => {
              const state = (task.state || 'unknown').toLowerCase();
              const badgeClass = state === 'success'
                ? 'bg-success'
                : state === 'failed'
                ? 'bg-danger'
                : state === 'running'
                ? 'bg-warning text-dark'
                : 'bg-secondary';
              const rawTaskId = task.task_id || 'unknown';
              const prettyTaskId = capitalizeWords(rawTaskId.replace(/_/g, ' '));
              const badgeLabel = capitalizeWords(task.state || 'unknown');
              const headerLabel = data.tasks.length > 1 ? prettyTaskId : 'Status';
              const header = `<strong>${escapeHtml(headerLabel)}</strong> <span class="badge ${badgeClass} ms-2">${escapeHtml(badgeLabel)}</span>`;
              const logText = normalizeLog(task.log || 'No log content yet.');
              const meta = [
                task.start_date ? `Started: ${escapeHtml(task.start_date)}` : '',
                task.end_date ? `Ended: ${escapeHtml(task.end_date)}` : ''
              ].filter(Boolean).join(' | ');
              const metaHtml = meta ? `<div class="text-muted mb-1">${meta}</div>` : '';
              return `<details class="mb-2"><summary>${header}</summary>${metaHtml}<pre class="bg-light p-2 rounded">${escapeHtml(logText)}</pre></details>`;
            }).join('');
          } else {
            tasksEl.innerHTML = '<p class="text-muted mb-0">No task updates yet.</p>';
          }

          if (!data.complete) {
            setTimeout(pollStatus, 5000);
          } else {
            polling = false;
            enableStart();
          }
        } catch (err) {
          messageEl.textContent = 'Error fetching Airflow status.';
          if (sourceEl) {
            sourceEl.textContent = 'N/A';
          }
          polling = false;
          enableStart();
        }
      }

      pollStatus();
    })();
  </script>
{% endif %}
{% endblock %}






