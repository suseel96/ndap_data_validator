{% extends "base.html" %}

{% block content %}
  <h4 class="mb-3">My Logs</h4>

  <div class="card">
    <div class="card-body p-0">
      <div class="table-responsive" style="max-height: 70vh; overflow-y: auto;">
        <table class="table table-sm table-striped mb-0" data-role="pipeline-table" data-dag-id="{{ airflow_dag_id or '' }}">
          <thead class="table-light">
            <tr>
              <th>Time</th>
              <th>Tracking ID</th>
              <th>User</th>
              <th>Filename</th>
              <th>Validation status</th>
              <th>Validation comments</th>
              <th>Upload status</th>
              <th>Upload key</th>
              <th>Upload comments</th>
              <th>Airflow DAG status</th>
              <th>Source code</th>
              <th>Load type</th>
              <th>DAG Run ID</th>
            </tr>
          </thead>
          <tbody>
            {% if pipeline_logs %}
              {% for row in pipeline_logs %}
                <tr data-token="{{ row.token or '' }}" data-dag-run-id="{{ row.dag_run_id or '' }}" data-airflow-status="{{ row.airflow_status or '' }}">
                  <td>{{ row.event_time or '' }}</td>
                  <td><code>{{ row.run_id or '' }}</code></td>
                  <td>{{ row.username or '' }}</td>
                  <td>{{ row.filename or '' }}</td>
                  <td>{{ row.validation_status or 'Not run' }}</td>
                  <td>{{ row.validation_comments or '' }}</td>
                  <td>{{ row.upload_status or '' }}</td>
                  <td><code>{{ row.upload_key or '' }}</code></td>
                  <td>{{ row.upload_comments or '' }}</td>
                  <td data-col="airflow-status">{{ row.airflow_status or 'Not triggered' }}</td>
                  <td data-col="source-code">{{ row.source_code or 'N/A' }}</td>
                  <td data-col="load-mode">{% set lm = row.load_mode or '' %}{% set lm_label = '' %}{% if lm == 'full_reload' %}{% set lm_label = 'Existing dataset - Full Reload' %}{% elif lm == 'delta' %}{% set lm_label = 'Existing dataset - Delta Loading' %}{% elif lm == 'structure_change' %}{% set lm_label = 'Existing dataset - Structure change' %}{% elif lm == 'new' %}{% set lm_label = 'New dataset' %}{% endif %}{{ lm_label }}</td>
                  <td data-col="dag-run-id"><code>{{ row.dag_run_id or '' }}</code></td>
                </tr>
              {% endfor %}
            {% else %}
              <tr>
                <td colspan="13" class="text-center text-muted py-3">No log entries found.</td>
              </tr>
            {% endif %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
  <script>
    (function () {
      const table = document.querySelector('[data-role="pipeline-table"]');
      if (!table) {
        return;
      }
      const dagId = (table.getAttribute('data-dag-id') || '').trim();
      if (!dagId) {
        return;
      }
      const terminalStates = new Set(['success', 'failed', 'error', 'upstream_failed', 'upstream failed']);
      const toTitle = (value) => String(value || '').replace(/_/g, ' ').replace(/\b\w/g, (ch) => ch.toUpperCase());

      table.querySelectorAll('tbody tr[data-token]').forEach((row) => {
        const runId = (row.getAttribute('data-dag-run-id') || '').trim();
        if (!runId) {
          return;
        }
        const currentState = (row.getAttribute('data-airflow-status') || '').toLowerCase();
        if (terminalStates.has(currentState)) {
          return;
        }
        const tokenValue = (row.getAttribute('data-token') || '').trim();
        const params = new URLSearchParams({ dag_id: dagId, dag_run_id: runId });
        if (tokenValue) {
          params.append('token', tokenValue);
        }
        fetch(`/airflow/run-status?${params.toString()}`)
          .then((resp) => (resp.ok ? resp.json() : null))
          .then((data) => {
            if (!data) {
              return;
            }
            const stateValue = toTitle(data.state || currentState);
            if (stateValue) {
              row.setAttribute('data-airflow-status', stateValue);
              const statusCell = row.querySelector('[data-col="airflow-status"]');
              if (statusCell) {
                statusCell.textContent = stateValue;
              }
            }
            if (Object.prototype.hasOwnProperty.call(data, 'source_code') && data.source_code) {
              const sourceCell = row.querySelector('[data-col="source-code"]');
              if (sourceCell) {
                sourceCell.textContent = data.source_code;
              }
            }
            if (data.dag_run_id) {
              const runCell = row.querySelector('[data-col="dag-run-id"]');
              if (runCell) {
                runCell.textContent = data.dag_run_id;
              }
            }
          })
          .catch(() => {});
      });
    })();
  </script>
{% endblock %}



