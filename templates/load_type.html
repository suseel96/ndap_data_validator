{% extends "base.html" %}

{% block content %}
  <h4 class="mb-3">Select load type</h4>
  {# normalize readiness and missing lists with safe defaults #}
  {% set s3_ready = settings_s3_ready | default(true) %}
  {% set airflow_ok = settings_airflow_ready | default(true) %}
  {% set missing_s3 = missing_settings_s3 | default([]) %}
  {% set missing_air = missing_settings_airflow | default([]) %}
  {% set is_admin = request.session.get('is_admin') %}

  {# For non-admin users show a single friendly message instead of detailed keys #}
  {% if not is_admin and (not s3_ready or not airflow_ok) %}
    <div class="alert alert-warning">
      Settings not configured yet. Kindly inform your Admin to login and configure S3 and Airflow settings.
    </div>
  {% else %}
    {% if (not s3_ready) and (missing_s3 | length > 0) %}
      <div class="alert alert-warning">
        S3 upload settings are incomplete. Missing: {{ ', '.join(missing_s3) }}.
        <a href="/admin/settings" class="alert-link">Open Settings</a>
      </div>
    {% endif %}
    {% if (not airflow_ok) and (missing_air | length > 0) %}
      <div class="alert alert-warning">
        Airflow trigger settings are incomplete. Missing: {{ ', '.join(missing_air) }}.
        <a href="/admin/settings" class="alert-link">Open Settings</a>
      </div>
    {% endif %}
  {% endif %}
  {% set settings_ready = s3_ready and airflow_ok %}
  <form method="post" action="/load-type/save" class="card p-3 card-narrow">
    {% if not settings_ready %}<fieldset disabled>{% endif %}
    <div class="list-group">
      <label class="list-group-item d-flex gap-2">
        <input class="form-check-input mt-1" type="radio" name="load_mode" value="new" {% if (load_mode or 'new') == 'new' %}checked{% endif %}>
        <span>
          <div class="fw-semibold">New dataset</div>
          <div class="small text-muted">Upload a new dataset</div>
        </span>
      </label>
      <label class="list-group-item d-flex gap-2">
        <input class="form-check-input mt-1" type="radio" name="load_mode" value="full_reload" {% if load_mode == 'full_reload' %}checked{% endif %}>
        <span>
          <div class="fw-semibold">Existing dataset - Full Reload</div>
          <div class="small text-muted">Full reload by wiping all existing data.<br>Choose this when you want to reload the complete data of an existing dataset/sourcecode.<br>Make sure the datafle contains the complete data to reload.</div>
        </span>
      </label>
      <label class="list-group-item d-flex gap-2">
        <input class="form-check-input mt-1" type="radio" name="load_mode" value="delta" {% if load_mode == 'delta' %}checked{% endif %}>
        <span>
          <div class="fw-semibold">Existing dataset - Delta Loading</div>
          <div class="small text-muted">Load only delta data without wiping existing data.<br>Choose this when you want to append additional data to an existing dataset/sourcecode.<br>Make sure the datafle contains only the new data to append.</div>
        </span>
      </label>
      <label class="list-group-item d-flex gap-2">
        <input class="form-check-input mt-1" type="radio" name="load_mode" value="structure_change" {% if load_mode == 'structure_change' %}checked{% endif %}>
        <span>
          <div class="fw-semibold">Existing dataset - Structure change</div>
          <div class="small text-muted">Handle structure changes for existing dataset.<br>Choose this when you want to reload the complete data of an existing dataset/sourcecode due to change in structure of latest data.<br>Make sure the datafle contains the complete data to reload according to the new data structure.</div>
        </span>
      </label>
    </div>
    <button class="btn btn-primary mt-3" type="submit" {% if not settings_ready %}disabled title="Complete settings first"{% endif %}>Continue</button>
    {% if not settings_ready %}</fieldset>{% endif %}
  </form>
{% endblock %}
