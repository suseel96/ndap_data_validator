{% extends "base.html" %}

{% block content %}
  <h4 class="mb-3">Step 4: Upload to AWS S3 {% if file_name %}<span class="text-muted">&mdash; {{ file_name }} ({{ record_count }} records)</span>{% endif %}</h4>
  {% if error %}
    <div class="alert alert-danger">{{ error }}</div>
    {% if trace %}<pre class="small">{{ trace }}</pre>{% endif %}
  {% endif %}
  {% if not settings_ready %}
    <div class="alert alert-warning">
      Step 4 is disabled until required settings are configured. Missing: {{ ', '.join(missing_settings) }}.
      <a href="/admin/settings" class="alert-link">Open Settings</a>
    </div>
  {% endif %}
  <form method="post" action="/upload" class="mt-3" id="s3UploadForm">
    <input type="hidden" name="token" value="{{ token }}" />
    <input type="hidden" name="columns" value="{{ '|||' . join(columns) }}" />{% for col in columns %}
      <input type="hidden" name="role_{{ col }}" value="{{ role_selection[col] }}" />
    {% endfor %}
    <input type="hidden" name="run_id" value="{{ run_id or '' }}" />

    {% if not settings_ready %}<fieldset disabled>{% endif %}
    {% if (load_mode or 'new') == 'new' %}
      <div class="row g-3">
        <div class="col-md-6">
          <label class="form-label">File name including extension (to save in AWS S3)</label>
          <input class="form-control" type="text" name="object_key_name" value="{{ object_key_value }}" required />
        </div>
      </div>

      <hr class="my-4" />
      <div class="row g-3">
        <div class="col-md-6">
          <label class="form-label">S3 folder name</label>
          <input class="form-control" type="text" name="s3_folder_name" value="{{ s3_folder_value }}" placeholder="folder-name without /" required />
          <div class="form-text">The uploaded file will be saved inside this folder with a <code>/pending/</code> suffix.</div>
        </div>
      </div>
    {% else %}
      <div class="row g-3">
        <div class="col-md-6">
          <label class="form-label">Source Code</label>
          <input class="form-control" type="text" name="source_code_value" placeholder="Enter source code" required />
          <div class="form-text">We will save as <code>sourcecode/pending/sourcecode.csv</code> in S3.</div>
        </div>
      </div>
    {% endif %}

    {% if not settings_ready %}</fieldset>{% endif %}
    <button class="btn btn-primary mt-3" type="submit">Upload to S3</button>
  </form>
  <script>
    document.getElementById('s3UploadForm')?.addEventListener('submit', function(){
      if (typeof window.showLoader === 'function') {
        window.showLoader('Uploading validated data to S3...');
      }
    });
  </script>
{% endblock %}


