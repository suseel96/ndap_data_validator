{% extends "base.html" %}

{% block content %}
  <h4 class="mb-3">Step 4: Upload to AWS S3 {% if file_name %}<span class="text-muted">&mdash; {{ file_name }} ({{ record_count }} records)</span>{% endif %}</h4>
  {% if not settings_ready %}
    <div class="alert alert-warning">
      Step 4 is disabled until required settings are configured. Missing: {{ ', '.join(missing_settings) }}.
      <a href="/admin/settings" class="alert-link">Open Settings</a>
    </div>
  {% endif %}
  <form method="post" action="/upload" class="mt-3">
    <input type="hidden" name="token" value="{{ token }}" />
    <input type="hidden" name="columns" value="{{ '|||' . join(columns) }}" />
    <input type="hidden" name="time_date_only" value="{% if time_date_only %}on{% endif %}" />

    {% for col in columns %}
      <input type="hidden" name="role_{{ col }}" value="{{ role_selection[col] }}" />
    {% endfor %}

    {% if not settings_ready %}<fieldset disabled>{% endif %}
    <div class="row g-3">
      <div class="col-md-6">
        <label class="form-label">File name including extension (to save in AWS S3)</label>
        <input class="form-control" type="text" name="object_key_name" required />
      </div>
    </div>

    <div class="form-check form-switch mt-3">
      <input class="form-check-input" type="checkbox" name="upload_cleaned" id="upload_cleaned" checked>
      <label class="form-check-label" for="upload_cleaned">Upload cleaned CSV (else original)</label>
    </div>

    <hr class="my-4" />
    <h6 class="mb-2">Airflow Parameters</h6>
    {% if not settings_ready %}<fieldset disabled>{% endif %}
    <div class="row g-3">
      <div class="col-md-4">
        <label class="form-label">S3 folder name</label>
        <input class="form-control" type="text" name="s3_folder_name" placeholder="folder-name/" />
      </div>
      <div class="col-md-4 d-flex align-items-end">
        <div class="form-check form-switch">
          <input class="form-check-input" type="checkbox" name="is_incremental" id="is_incremental">
          <label class="form-check-label" for="is_incremental">Is Incremental</label>
        </div>
      </div>
      <div class="col-md-4 d-flex align-items-end">
        <div class="form-check form-switch">
          <input class="form-check-input" type="checkbox" name="schema_exists" id="schema_exists">
          <label class="form-check-label" for="schema_exists">Schema exists</label>
        </div>
      </div>
    </div>

    {% if not settings_ready %}</fieldset disabled>{% endif %}
    <button class="btn btn-primary mt-3" type="submit">Upload to S3</button>
  </form>
{% endblock %}
