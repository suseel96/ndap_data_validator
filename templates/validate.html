{% extends "base.html" %}

{% block content %}
  <h4 class="mb-3">Step 3: Perform validations {% if file_name %}<span class="text-muted">&mdash; {{ file_name }}</span>{% endif %}</h4>

  {% if file_results %}
    <style>
      .file-row { cursor: pointer; }
      .file-details { display: none; }
      .file-row.expanded + .file-details { display: table-row; }
      .file-name { text-decoration: underline; }
      .nested-table thead th { position: sticky; top: 0; background: #f8f9fa; }
      .nested-table { margin-left: 1.25rem; margin-right: 1.25rem; }
    </style>
    <div class="table-scroll mt-3"><table class="table table-sm table-validation">
      <thead>
        <tr>
          <th>Filename</th>
          <th>Rows</th>
          <th>Passed</th>
          <th>Failed Columns</th>
        </tr>
      </thead>
      <tbody>
        {% for fr in file_results %}
          <tr class="file-row {{ 'row-pass' if fr.passed else 'row-fail' }}" data-file-index="{{ loop.index0 }}">
            <td class="file-name"><code>{{ fr.file }}</code></td>
            <td>{{ fr.rows }}</td>
            <td>{{ 'Yes' if fr.passed else 'No' }}</td>
            <td>
              {% if fr.failed_columns and fr.failed_columns|length > 0 %}
                {{ fr.failed_columns | join(', ') }}
              {% else %}
                -
              {% endif %}
            </td>
          </tr>
          <tr class="file-details">
            <td colspan="4">
              <div class="table-scroll mt-2">
                <table class="table table-sm table-validation nested-table">
                  <thead>
                    <tr>
                      <th>Column Name</th>
                      <th>Column Type</th>
                      <th>Nulls</th>
                      <th>Conversion errors</th>
                      <th>Passed</th>
                      <th>Reasons</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for r in fr.details or [] %}
                      <tr class="{{ 'row-pass' if r.passed else 'row-fail' }}">
                        <td>{{ r.column }}</td>
                        <td>{{ r.role }}</td>
                        <td>{{ r.nulls }}</td>
                        <td>{{ r.conversion_errors }}</td>
                        <td>{{ 'Yes' if r.passed else 'No' }}</td>
                        <td>{{ r.reasons }}</td>
                      </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table></div>
    <script>
      document.querySelectorAll('.file-row').forEach(function(row){
        row.addEventListener('click', function(){
          const isExpanded = row.classList.contains('expanded');
          // collapse others
          document.querySelectorAll('.file-row.expanded').forEach(r => r.classList.remove('expanded'));
          document.querySelectorAll('.file-details').forEach(d => d.style.display = 'none');
          if (!isExpanded) {
            row.classList.add('expanded');
            const details = row.nextElementSibling;
            if (details && details.classList.contains('file-details')) {
              details.style.display = 'table-row';
            }
          }
        });
      });
    </script>
  {% else %}
    <div class="table-scroll mt-3"><table class="table table-sm table-validation">
      <thead>
        <tr>
          <th>Column Name</th>
          <th>Column Type</th>
          <th>Nulls</th>
          <th>Conversion errors</th>
          <th>Passed</th>
          <th>Reasons</th>
        </tr>
      </thead>
      <tbody>
        {% for r in rows %}
          <tr class="{{ 'row-pass' if r.passed else 'row-fail' }}">
            <td>{{ r.column }}</td>
            <td>{{ r.role }}</td>
            <td>{{ r.nulls }}</td>
            <td>{{ r.conversion_errors }}</td>
            <td>{{ 'Yes' if r.passed else 'No' }}</td>
            <td>{{ r.reasons }}</td>
          </tr>
        {% endfor %}
      </tbody>
    </table></div>
  {% endif %}

  {% if passed %}
    {% if file_results %}
      <div class="alert alert-success d-flex align-items-center justify-content-between">
        <div>All checks passed. Proceed to the next step to trigger the Airflow DAG.</div>
        <a class="btn btn-primary" href="/airflow-trigger?token={{ token }}">Proceed to Airflow</a>
      </div>
    {% else %}
      <div class="alert alert-success d-flex align-items-center justify-content-between">
        <div>All checks passed. Proceed to the next step to upload to S3.</div>
        <a class="btn btn-primary" href="/upload?token={{ token }}">Proceed to upload</a>
      </div>
    {% endif %}
  {% else %}
    <div class="alert alert-danger">Validation failed. Go back to Step 2 to adjust column roles and try again.</div>
  {% endif %}

  <script></script>
{% endblock %}
