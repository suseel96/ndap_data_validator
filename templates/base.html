<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>{{ title or 'CSV Validator' }}</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="/static/style.css?v=4" />
    <style>
      .loader-overlay { position: fixed; inset: 0; z-index: 2000; display: none; }
      .loader-overlay .loader-backdrop { position: absolute; inset: 0; background: rgba(255,255,255,.7); backdrop-filter: blur(1px); }
      .loader-overlay .loader-content { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); display: flex; align-items: center; background: #fff; border: 1px solid #dee2e6; border-radius: .5rem; padding: .75rem 1rem; box-shadow: 0 2px 8px rgba(0,0,0,.05); }
      .loader-overlay .loader-text { font-weight: 500; }
    </style>
  </head>
  <body>
    <div id="globalLoader" class="loader-overlay" style="display:none;">
      <div class="loader-backdrop"></div>
      <div class="loader-content">
        <div class="spinner-border text-primary" role="status" aria-hidden="true"></div>
        <div class="loader-text ms-2" id="globalLoaderText">Working...</div>
      </div>
    </div>
    <header class="app-header py-2 px-3 border-bottom">
      <div class="container-fluid d-flex align-items-center justify-content-between">
        <h5 class="m-0 brand-title"><a href="/load-type?reset=1" class="brand-title-link">NDAP Data Validator</a></h5>
        <div>
          {% if request.session.get('username') %}
            <span class="me-2">Signed in as <strong>{{ request.session.get('username') }}</strong></span>
            {% if request.session.get('is_admin') %}
              <a class="btn btn-sm btn-outline-primary me-2" href="/admin/users">Admin Panel</a>
              <a class="btn btn-sm btn-outline-primary me-2" href="/admin/logs">Logs</a>
              <a class="btn btn-sm btn-outline-primary me-2" href="/admin/settings">Settings</a>
            {% endif %}
            <a class="btn btn-sm btn-outline-primary me-2" href="/load-type?reset=1">Upload New File</a>
            <a class="btn btn-sm btn-outline-primary me-2" href="/logs">My Logs</a>
            <a class="btn btn-sm btn-primary" href="/logout">Logout</a>
          {% else %}
            {% if request.url.path != '/login' %}
              <a class="btn btn-sm btn-primary" href="/login">Login</a>
            {% endif %}
          {% endif %}
        </div>
      </div>
    </header>

    <div class="container-fluid app-shell">
      {% if show_stepper | default(true) %}
      <div class="pt-3 pb-2">
        {% if run_id %}
        <div class="mb-2 d-flex align-items-center gap-2 flex-wrap">
          <span class="badge bg-light text-dark border">Tracking ID: <code>{{ run_id }}</code></span>
          {% set lm = request.session.get('load_mode') %}
          {% if lm %}
            {% set lm_label = 'New dataset' %}
            {% if lm == 'full_reload' %}{% set lm_label = 'Existing dataset - Full Reload' %}{% endif %}
            {% if lm == 'delta' %}{% set lm_label = 'Existing dataset - Delta Loading' %}{% endif %}
            {% if lm == 'structure_change' %}{% set lm_label = 'Existing dataset - Structure change' %}{% endif %}
            <span class="badge bg-primary">Load type: {{ lm_label }}</span>
          {% endif %}
        </div>
        {% endif %}
        <ol class="stepper stepper-horizontal list-unstyled d-flex gap-4 flex-wrap">
          {% set token_q = token if token is defined and token else None %}
          {% set qs = ('?token=' ~ token_q) if token_q else '' %}
          {% set lock_backwards = (active_step | default(1)) >= 5 %}
          {% set completed = completed_steps | default([]) %}
          
          <li class="step {% if active_step == 1 %}active{% endif %} {% if 1 in completed %}completed{% endif %}">
            {% if active_step > 1 and not lock_backwards %}
              <a href="/" class="step-link">
                <div class="step-icon">1</div>
                <div class="step-title">Upload CSV and preview</div>
              </a>
            {% else %}
              <span class="step-link{% if active_step < 1 %} disabled{% endif %}">
                <div class="step-icon">1</div>
                <div class="step-title">Upload CSV and preview</div>
              </span>
            {% endif %}
          </li>
          <li class="step {% if active_step == 2 %}active{% endif %} {% if 2 in completed %}completed{% endif %} {% if 1 not in completed %}disabled{% endif %}">
            {% if active_step > 2 and (1 in completed) and not lock_backwards %}
              <a href="/preview{{ qs }}" class="step-link">
                <div class="step-icon">2</div>
                <div class="step-title">Select column types</div>
              </a>
            {% else %}
              <span class="step-link{% if 1 not in completed or active_step < 2 %} disabled{% endif %}">
                <div class="step-icon">2</div>
                <div class="step-title">Select column types</div>
              </span>
            {% endif %}
          </li>
          <li class="step {% if active_step == 3 %}active{% endif %} {% if 3 in completed %}completed{% endif %} {% if 2 not in completed %}disabled{% endif %}">
            {% if active_step > 3 and (2 in completed) and not lock_backwards %}
              <a href="/validate{{ qs }}" class="step-link">
                <div class="step-icon">3</div>
                <div class="step-title">Perform validations</div>
              </a>
            {% else %}
              <span class="step-link{% if 2 not in completed or active_step < 3 %} disabled{% endif %}">
                <div class="step-icon">3</div>
                <div class="step-title">Perform validations</div>
              </span>
            {% endif %}
          </li>
          {% set s3_mode = s3_folder_mode | default(false) %}
          {% set step4_label = 'Ready for Airflow' if s3_mode else 'Upload to AWS S3' %}
          {% set step4_href = ('/airflow-trigger' ~ qs) if s3_mode else ('/upload' ~ qs) %}
          <li class="step {% if active_step == 4 %}active{% endif %} {% if 4 in completed %}completed{% endif %} {% if 3 not in completed %}disabled{% endif %}">
            {% if active_step > 4 and (3 in completed) and not lock_backwards %}
              <a href="{{ step4_href }}" class="step-link">
                <div class="step-icon">4</div>
                <div class="step-title">{{ step4_label }}</div>
              </a>
            {% else %}
              <span class="step-link{% if 3 not in completed or active_step < 4 %} disabled{% endif %}">
                <div class="step-icon">4</div>
                <div class="step-title">{{ step4_label }}</div>
              </span>
            {% endif %}
          </li>
          <li class="step {% if active_step == 5 %}active{% endif %} {% if 5 in completed %}completed{% endif %} {% if 4 not in completed %}disabled{% endif %}">
            {% if active_step > 5 and (4 in completed) and not lock_backwards %}
              <a href="/airflow-trigger{{ qs }}" class="step-link">
                <div class="step-icon">5</div>
                <div class="step-title">Trigger Airflow</div>
              </a>
            {% else %}
              <span class="step-link{% if 4 not in completed or active_step < 5 %} disabled{% endif %}">
                <div class="step-icon">5</div>
                <div class="step-title">Trigger Airflow</div>
              </span>
            {% endif %}
          </li>
        </ol>
      </div>
      {% endif %}
      <div class="row">
        <main class="col-12 py-3">
          {% if error %}
            <div class="alert alert-danger">{{ error }}</div>
          {% endif %}
          {% if trace %}
            <pre class="small">{{ trace }}</pre>
          {% endif %}

          {% block content %}{% endblock %}
        </main>
      </div>
    </div>
  </body>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    (function(){
      const overlay = document.getElementById('globalLoader');
      const textEl = document.getElementById('globalLoaderText');
      function show(msg){ if(textEl){ textEl.textContent = msg || 'Working...'; } if(overlay){ overlay.style.display='block'; } }
      function hide(){ if(overlay){ overlay.style.display='none'; } }
      window.showLoader = show; window.hideLoader = hide;
      // Auto-hook forms with data-loading-message
      document.addEventListener('DOMContentLoaded', function(){
        document.querySelectorAll('form[data-loading-message]').forEach(function(f){
          f.addEventListener('submit', function(){ show(f.getAttribute('data-loading-message') || 'Working...'); });
        });
      });
    })();
  </script>
  </html>
