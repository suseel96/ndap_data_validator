{% extends "base.html" %}

{% block content %}
  <h4 class="mb-3">Step 5: Trigger Airflow {% if file_name %}<span class="text-muted">&mdash; {{ file_name }}{% if not s3_folder_mode %} ({{ record_count }} records){% endif %}</span>{% endif %}</h4>

  {% if uploaded_recently %}
    <div class="alert alert-success">File uploaded to <code>{{ s3_uri }}</code>.</div>
  {% endif %}

  {% if error %}
    <div class="alert alert-danger">{{ error }}</div>
    {% if trace %}<pre class="small">{{ trace }}</pre>{% endif %}
  {% endif %}

  {% if not airflow_ready %}
    <div class="alert alert-warning">
      Airflow trigger is disabled until settings are configured. Missing: {{ ', '.join(missing_settings) }}.
      <a href="/admin/settings" class="alert-link">Open Settings</a>
    </div>
  {% endif %}

  <div class="card mb-3">
    <div class="card-body">
      {% if s3_folder_mode %}
        <h6 class="card-title">S3 Folder</h6>
        <dl class="row mb-0 small">
          <dt class="col-sm-3">Bucket</dt>
          <dd class="col-sm-9"><code>{{ s3_bucket }}</code></dd>
          <dt class="col-sm-3">Prefix</dt>
          <dd class="col-sm-9"><code>{{ s3_folder }}</code></dd>
          <dt class="col-sm-3">S3 URI</dt>
          <dd class="col-sm-9"><code>{{ s3_uri }}</code></dd>
        </dl>
      {% else %}
        <h6 class="card-title">S3 Upload</h6>
        <dl class="row mb-0 small">
          <dt class="col-sm-3">Bucket</dt>
          <dd class="col-sm-9"><code>{{ s3_bucket }}</code></dd>
          <dt class="col-sm-3">Key</dt>
          <dd class="col-sm-9"><code>{{ s3_object_key }}</code></dd>
          <dt class="col-sm-3">Folder</dt>
          <dd class="col-sm-9">{{ s3_folder or '-' }}</dd>
          <dt class="col-sm-3">S3 URI</dt>
          <dd class="col-sm-9"><code>{{ s3_uri }}</code></dd>
        </dl>
      {% endif %}
    </div>
  </div>

  <form method="post" action="/airflow-trigger" class="mt-3" id="airflowForm">
    <input type="hidden" name="token" value="{{ token }}" />
    <input type="hidden" name="run_id" value="{{ run_id or '' }}" />
    {% if airflow_ready and not airflow_triggered %}<fieldset>{% else %}<fieldset disabled>{% endif %}
      <div class="mb-2">Select load type</div>
      <div class="list-group">
        <label class="list-group-item d-flex align-items-start gap-2">
          <input class="form-check-input mt-1" type="radio" name="load_mode" value="new" {% if load_mode == 'new' %}checked{% endif %}>
          <span>
            <div class="fw-semibold">New dataset</div>
            <div class="small text-muted">Upload a new dataset</div>
          </span>
        </label>
        <label class="list-group-item d-flex align-items-start gap-2">
          <input class="form-check-input mt-1" type="radio" name="load_mode" value="full_reload" {% if load_mode == 'full_reload' %}checked{% endif %}>
          <span>
            <div class="fw-semibold">Existing dataset - Full Reload</div>
            <div class="small text-muted">Full reload by wiping all existing data</div>
          </span>
        </label>
        <label class="list-group-item d-flex align-items-start gap-2">
          <input class="form-check-input mt-1" type="radio" name="load_mode" value="delta" {% if load_mode == 'delta' %}checked{% endif %}>
          <span>
            <div class="fw-semibold">Existing dataset - Delta Loading</div>
            <div class="small text-muted">Load only delta data without wiping data</div>
          </span>
        </label>
        <label class="list-group-item d-flex align-items-start gap-2">
          <input class="form-check-input mt-1" type="radio" name="load_mode" value="structure_change" {% if load_mode == 'structure_change' %}checked{% endif %}>
          <span>
            <div class="fw-semibold">Existing dataset - Structure change</div>
            <div class="small text-muted">Handle structure changes for existing dataset</div>
          </span>
        </label>
      </div>
    </fieldset>
    <button class="btn btn-primary mt-3" type="submit" {% if not airflow_ready or airflow_triggered %}disabled{% endif %}>Trigger DAG</button>
  </form>
  <script>
    document.getElementById('airflowForm')?.addEventListener('submit', function(){
      if (typeof window.showLoader === 'function') {
        window.showLoader('Triggering Airflow DAG...');
      }
    });
  </script>
{% endblock %}
