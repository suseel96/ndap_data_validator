{% extends "base.html" %}

{% block content %}
  <h4 class="mb-3">Step 5: Trigger Airflow {% if file_name %}<span class="text-muted">&mdash; {{ file_name }}{% if not s3_folder_mode %} ({{ record_count }} records){% endif %}</span>{% endif %}</h4>

  {% if uploaded_recently %}
    <div class="alert alert-success">File uploaded to <code>{{ s3_uri }}</code>.</div>
  {% endif %}

  {% if error %}
    <div class="alert alert-danger">{{ error }}</div>
    {% if trace %}<pre class="small">{{ trace }}</pre>{% endif %}
  {% endif %}

  {% if not airflow_ready %}
    <div class="alert alert-warning">
      Airflow trigger is disabled until settings are configured. Missing: {{ ', '.join(missing_settings) }}.
      <a href="/admin/settings" class="alert-link">Open Settings</a>
    </div>
  {% endif %}

  {% if airflow_triggered %}
    <div class="alert alert-success d-flex align-items-center justify-content-between">
      <div>
        Airflow DAG triggered.
        {% if airflow_dag_run_id %}
          Run ID: <code>{{ airflow_dag_run_id }}</code>
        {% endif %}
        {% if airflow_run_url %}
          &nbsp;|&nbsp;<a href="{{ airflow_run_url }}" class="alert-link" target="_blank" rel="noopener">Open in Airflow</a>
        {% endif %}
      </div>
    </div>
    {% if airflow_dag_run_id and airflow_dag_id %}
      <div class="card mt-3" id="airflow-status-card" data-dag-id="{{ airflow_dag_id }}" data-run-id="{{ airflow_dag_run_id }}" data-token="{{ token }}">
        <div class="card-header">Airflow Run Status</div>
        <div class="card-body">
          <div id="airflow-status-message" data-role="message" class="mb-2 text-muted">Checking Airflow run status...</div>
          <div class="mb-2"><strong>Source Code:</strong> <span data-role="source-code">N/A</span></div>
          <div id="airflow-status-error" data-role="tasks-error" class="text-warning small mb-2" style="display:none;"></div>
          <div id="airflow-status-tasks" data-role="tasks" class="small"></div>
        </div>
      </div>
    {% endif %}
  {% endif %}

  <div class="card mb-3">
    <div class="card-body">
      {% if s3_folder_mode %}
        <h6 class="card-title">S3 Folder</h6>
        <dl class="row mb-0 small">
          <dt class="col-sm-3">Bucket</dt>
          <dd class="col-sm-9"><code>{{ s3_bucket }}</code></dd>
          <dt class="col-sm-3">Prefix</dt>
          <dd class="col-sm-9"><code>{{ s3_folder }}</code></dd>
          <dt class="col-sm-3">S3 URI</dt>
          <dd class="col-sm-9"><code>{{ s3_uri }}</code></dd>
        </dl>
      {% else %}
        <h6 class="card-title">S3 Upload</h6>
        <dl class="row mb-0 small">
          <dt class="col-sm-3">Bucket</dt>
          <dd class="col-sm-9"><code>{{ s3_bucket }}</code></dd>
          <dt class="col-sm-3">Key</dt>
          <dd class="col-sm-9"><code>{{ s3_object_key }}</code></dd>
          <dt class="col-sm-3">Folder</dt>
          <dd class="col-sm-9">{{ s3_folder or '-' }}</dd>
          <dt class="col-sm-3">S3 URI</dt>
          <dd class="col-sm-9"><code>{{ s3_uri }}</code></dd>
        </dl>
      {% endif %}
    </div>
  </div>

  <form method="post" action="/airflow-trigger" class="mt-3" id="airflowForm"
        data-load-mode="{{ load_mode or 'new' }}"
        data-s3-folder-mode="{{ 'true' if s3_folder_mode else 'false' }}"
        data-s3-bucket="{{ s3_bucket or '' }}"
        data-s3-folder="{{ s3_folder or '' }}"
        data-s3-uri="{{ s3_uri or '' }}"
        data-s3-object-key="{{ s3_object_key or '' }}"
        data-source-code="{{ s3_folder or '' }}">
    <input type="hidden" name="token" value="{{ token }}" />
    <input type="hidden" name="run_id" value="{{ run_id or '' }}" />
    <!-- Load type is already selected in Validate step, no inputs here -->
    <div id="triggerBar">
      <button class="btn btn-primary mt-3" type="button" id="openConfirmBtn" {% if not airflow_ready or airflow_triggered %}disabled{% endif %}>Trigger DAG</button>
    </div>
    <a href="/load-type?reset=1" id="startOverLink" class="btn btn-outline-primary mt-3 d-none">Start over</a>
  </form>
  
  <!-- Confirm Modal -->
  <div class="modal fade" id="confirmModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Confirm Airflow Trigger</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p class="mb-2">Please review your selections:</p>
          <ul class="mb-0">
            <li><strong>Load type:</strong> <span data-role="cfm-mode">-</span></li>
            <li><strong>Source code:</strong> <span data-role="cfm-source">-</span></li>
            <li><strong>S3 target:</strong> <span data-role="cfm-s3">-</span></li>
            <li class="mt-2"><strong>Flags:</strong>
              <div class="small text-muted ms-2">
                is_incremental: <span data-role="cfm-inc">-</span>,
                schema_exist: <span data-role="cfm-sch">-</span>,
                delta_with_structure_change: <span data-role="cfm-delta">-</span>
              </div>
            </li>
          </ul>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" id="confirmTriggerBtn">Confirm & Trigger</button>
        </div>
      </div>
    </div>
  </div>
  <script>
    (function(){
      const form = document.getElementById('airflowForm');
      const modalEl = document.getElementById('confirmModal');
      const confirmBtn = document.getElementById('confirmTriggerBtn');
      const openBtn = document.getElementById('openConfirmBtn');
      const startOverLink = document.getElementById('startOverLink');
      const triggerBar = document.getElementById('triggerBar');
      let modal;
      let pending = false;
      function yesNo(v){ return v ? 'yes' : 'no'; }
      function modeLabel(val){
        switch((val||'').toLowerCase()){
          case 'full_reload': return 'Existing dataset - Full Reload';
          case 'delta': return 'Existing dataset - Delta Loading';
          case 'structure_change': return 'Existing dataset - Structure change';
          default: return 'New dataset';
        }
      }
      function populateSummary(){
        const selected = form.querySelector('input[name="load_mode"]:checked');
        const mode = selected ? selected.value : (form.dataset.loadMode || 'new');
        const s3FolderMode = (form.dataset.s3FolderMode === 'true');
        const s3Bucket = form.dataset.s3Bucket || '';
        const s3Folder = form.dataset.s3Folder || '';
        const s3Uri = form.dataset.s3Uri || '';
        const s3ObjectKey = form.dataset.s3ObjectKey || '';
        const s3Text = s3FolderMode ? (s3Bucket ? (`s3://${s3Bucket}/${s3Folder}`) : s3Uri) : (s3Bucket ? (`s3://${s3Bucket}/${s3ObjectKey}`) : s3Uri);
        const src = form.dataset.sourceCode || s3Folder || '';
        // derive flags from mode
        let inc=false, sch=false, dsc=false;
        if (mode==='full_reload'){ inc=false; sch=true; dsc=false; }
        else if (mode==='delta'){ inc=true; sch=true; dsc=false; }
        else if (mode==='structure_change'){ inc=false; sch=false; dsc=true; }
        else { inc=false; sch=false; dsc=false; }
        modalEl.querySelector('[data-role="cfm-mode"]').textContent = modeLabel(mode);
        modalEl.querySelector('[data-role="cfm-source"]').textContent = src || '-';
        modalEl.querySelector('[data-role="cfm-s3"]').textContent = s3Text || '-';
        modalEl.querySelector('[data-role="cfm-inc"]').textContent = yesNo(inc);
        modalEl.querySelector('[data-role="cfm-sch"]').textContent = yesNo(sch);
        modalEl.querySelector('[data-role="cfm-delta"]').textContent = yesNo(dsc);
      }
      if (form && modalEl && window.bootstrap && window.bootstrap.Modal){ modal = new window.bootstrap.Modal(modalEl); }
      if (openBtn){
        openBtn.addEventListener('click', function(){
          if (pending) return;
          if (!modal && window.bootstrap && window.bootstrap.Modal){
            modal = new window.bootstrap.Modal(modalEl);
          }
          populateSummary();
          if (modal){ modal.show(); }
          else {
            const ok = window.confirm('Trigger Airflow DAG with the selected options?');
            if (ok){
              pending = true;
              if (typeof window.showLoader === 'function') { window.showLoader('Triggering Airflow DAG...'); }
              form.submit();
            }
          }
        });
      }
      if (confirmBtn){
        confirmBtn.addEventListener('click', function(){
          pending = true;
          modal && modal.hide();
          if (typeof window.showLoader === 'function') {
            window.showLoader('Triggering Airflow DAG...');
          }
          form.submit();
        });
      }
    })();
    // Status polling if we have a triggered run
    (function(){
      const card = document.getElementById('airflow-status-card');
      if (!card) return;
      const triggerForm = document.getElementById('airflowForm');
      const mode = (triggerForm && triggerForm.dataset && triggerForm.dataset.loadMode ? triggerForm.dataset.loadMode : 'new').toLowerCase();
      let providedSource = '';
      if (mode !== 'new' && triggerForm && triggerForm.dataset){
        if ((triggerForm.dataset.s3FolderMode || 'false') === 'true'){
          let pref = (triggerForm.dataset.s3Folder || '').replace(/^\/+|\/+$/g, '');
          const idx = pref.indexOf('/pending');
          if (idx >= 0) pref = pref.substring(0, idx);
          if (pref.includes('/')) providedSource = pref.split('/').pop(); else providedSource = pref;
        } else {
          providedSource = (triggerForm.dataset.s3Folder || '');
        }
      }
      const startOverLink = document.getElementById('startOverLink');
      const triggerBar = document.getElementById('triggerBar');
      const dagId = card.getAttribute('data-dag-id');
      const runId = card.getAttribute('data-run-id');
      const tokenValue = card.getAttribute('data-token') || '';
      const messageEl = card.querySelector('[data-role="message"]');
      const tasksEl = card.querySelector('[data-role="tasks"]');
      const errorEl = card.querySelector('[data-role="tasks-error"]');
      const sourceEl = card.querySelector('[data-role="source-code"]');
      const capitalizeWords = (v) => String(v||'').replace(/\b\w/g, (ch)=>ch.toUpperCase());
      const normalizeLog = (v) => String(v||'').replace(/\r\n/g,'\n').replace(/\\r\\n/g,'\n').replace(/\\n/g,'\n').replace(/\\t/g,'\t');
      const escapeHtml = (value) => String(value || '').replace(/[&<>"']/g, (ch) => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[ch]||ch));
      let polling = true;
      function finish(){
        if (triggerBar) triggerBar.classList.add('d-none');
        if (startOverLink) startOverLink.classList.remove('d-none');
      }
      async function poll(){
        if (!polling) return;
        try {
          const params = new URLSearchParams({ dag_id: dagId, dag_run_id: runId });
          if (tokenValue) params.append('token', tokenValue);
          const resp = await fetch(`/airflow/run-status?${params.toString()}`);
          if (!resp.ok){ messageEl.textContent = `Unable to fetch Airflow status (HTTP ${resp.status}).`; polling=false; return; }
          const data = await resp.json();
          messageEl.textContent = data.state ? '' : 'State is not available yet.';
          if (data.tasks_error){ errorEl.style.display=''; errorEl.textContent = `Task details unavailable: ${data.tasks_error}`; }
          else { errorEl.style.display='none'; errorEl.textContent=''; }
          if (sourceEl){
            const codeValue = (data.source_code || '').toString().trim();
            if (mode !== 'new' && providedSource){
              sourceEl.textContent = providedSource;
            } else {
              sourceEl.textContent = codeValue ? codeValue : 'N/A';
            }
          }
          if (Array.isArray(data.tasks) && data.tasks.length){
            tasksEl.innerHTML = data.tasks.map((task)=>{
              const state = (task.state || 'unknown').toLowerCase();
              const badgeClass = state==='success'?'bg-success':state==='failed'?'bg-danger':state==='running'?'bg-warning text-dark':'bg-secondary';
              const rawTaskId = task.task_id || 'unknown';
              const prettyTaskId = capitalizeWords(rawTaskId.replace(/_/g, ' '));
              const badgeLabel = capitalizeWords(task.state || 'unknown');
              const headerLabel = data.tasks.length>1 ? prettyTaskId : 'Status';
              const header = `<strong>${escapeHtml(headerLabel)}</strong> <span class="badge ${badgeClass} ms-2">${escapeHtml(badgeLabel)}</span>`;
              const logText = normalizeLog(task.log || 'No log content yet.');
              return `<details class="mb-2"><summary>${header}</summary><pre class="bg-light p-2 rounded">${escapeHtml(logText)}</pre></details>`;
            }).join('');
          } else {
            tasksEl.innerHTML = '<p class="text-muted mb-0">No task updates yet.</p>';
          }
          if (!data.complete){ setTimeout(poll, 5000); } else { polling=false; finish(); }
        } catch(e){ messageEl.textContent='Error fetching Airflow status.'; polling=false; }
      }
      poll();
    })();
  </script>
{% endblock %}
