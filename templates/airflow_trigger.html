{% extends "base.html" %}

{% block content %}
  <h4 class="mb-3">Step 5: Trigger Airflow {% if file_name %}<span class="text-muted">&mdash; {{ file_name }}{% if not s3_folder_mode %} ({{ record_count }} records){% endif %}</span>{% endif %}</h4>

  {% if uploaded_recently %}
    <div class="alert alert-success">File uploaded to <code>{{ s3_uri }}</code>.</div>
  {% endif %}

  {% if error %}
    <div class="alert alert-danger">{{ error }}</div>
    {% if trace %}<pre class="small">{{ trace }}</pre>{% endif %}
  {% endif %}

  {% if not airflow_ready %}
    <div class="alert alert-warning">
      Airflow trigger is disabled until settings are configured. Missing: {{ ', '.join(missing_settings) }}.
      <a href="/admin/settings" class="alert-link">Open Settings</a>
    </div>
  {% endif %}

  <div class="card mb-3">
    <div class="card-body">
      {% if s3_folder_mode %}
        <h6 class="card-title">S3 Folder</h6>
        <dl class="row mb-0 small">
          <dt class="col-sm-3">Bucket</dt>
          <dd class="col-sm-9"><code>{{ s3_bucket }}</code></dd>
          <dt class="col-sm-3">Prefix</dt>
          <dd class="col-sm-9"><code>{{ s3_folder }}</code></dd>
          <dt class="col-sm-3">S3 URI</dt>
          <dd class="col-sm-9"><code>{{ s3_uri }}</code></dd>
        </dl>
      {% else %}
        <h6 class="card-title">S3 Upload</h6>
        <dl class="row mb-0 small">
          <dt class="col-sm-3">Bucket</dt>
          <dd class="col-sm-9"><code>{{ s3_bucket }}</code></dd>
          <dt class="col-sm-3">Key</dt>
          <dd class="col-sm-9"><code>{{ s3_object_key }}</code></dd>
          <dt class="col-sm-3">Folder</dt>
          <dd class="col-sm-9">{{ s3_folder or '-' }}</dd>
          <dt class="col-sm-3">S3 URI</dt>
          <dd class="col-sm-9"><code>{{ s3_uri }}</code></dd>
        </dl>
      {% endif %}
    </div>
  </div>

  <form method="post" action="/airflow-trigger" class="mt-3" id="airflowForm">
    <input type="hidden" name="token" value="{{ token }}" />
    <input type="hidden" name="run_id" value="{{ run_id or '' }}" />
    {% if airflow_ready %}<fieldset>{% else %}<fieldset disabled>{% endif %}
      <div class="row g-3">
        <div class="col-md-4 d-flex align-items-end">
          <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" name="is_incremental" id="is_incremental" {% if is_incremental %}checked{% endif %}>
            <label class="form-check-label" for="is_incremental">Is Incremental</label>
          </div>
        </div>
        <div class="col-md-4 d-flex align-items-end">
          <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" name="schema_exists" id="schema_exists" {% if is_incremental or schema_exists %}checked{% endif %} {% if is_incremental %}disabled{% endif %}>
            <label class="form-check-label" for="schema_exists">Schema exists</label>
          </div>
        </div>
      </div>
    </fieldset>
    <button class="btn btn-primary mt-3" type="submit" {% if not airflow_ready %}disabled{% endif %}>Trigger DAG</button>
  </form>
  <script>
    const inc = document.getElementById('is_incremental');
    const sch = document.getElementById('schema_exists');
    function syncSchemaExists() {
      if (!inc || !sch) return;
      if (inc.checked) {
        sch.checked = true;
        sch.setAttribute('disabled', 'disabled');
      } else {
        sch.removeAttribute('disabled');
      }
    }
    if (inc && sch) {
      inc.addEventListener('change', syncSchemaExists);
      // initialize on load
      syncSchemaExists();
    }
    document.getElementById('airflowForm')?.addEventListener('submit', function(){
      if (typeof window.showLoader === 'function') {
        window.showLoader('Triggering Airflow DAG...');
      }
    });
  </script>
{% endblock %}
